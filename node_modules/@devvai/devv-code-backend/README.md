# Devv Code Backend SDK

Internal SDK providing authentication and data storage functionality for Devv Code frontend projects.

## Authentication Requirements

For data security, most operations require authentication via `auth.verifyOTP()`:
- **Authentication required**: table write operations (add/update/delete), file upload, email sending, AI chat
- **No authentication needed**: table read operations (`getItems`)

Always ensure users are logged in before performing write operations or using AI/email features.

## Installation

```bash
npm install @devvai/devv-code-backend
```

## Import

```typescript
import { auth, table, upload, email } from '@devvai/devv-code-backend';
import { DevvAI } from '@devvai/devv-code-backend';
```

## Authentication API

### auth.sendOTP(email: string): Promise<void>
Sends a verification code to the user's email.

### auth.verifyOTP(email: string, verificationCode: string): Promise<AuthResponse>
Verifies the email verification code and logs in, returning user information and session.

### auth.logout(): Promise<void>
Logs out and clears the session.

## Data Table API

### table.addItem(tableId: string, data: Record<string, any>): Promise<void>
Adds a data item to the specified table.

### table.getItems(tableId: string, options?: GetItemsOptions): Promise<GetItemsResponse>
Queries table data with support for filtering, sorting, and pagination. Returns all data using the default `_tid_id_idx` index when no parameters are provided.

### table.updateItem(tableId: string, data: ItemData): Promise<void>
Updates a data item. The data must include complete primary keys.

### table.deleteItem(tableId: string, keys: ItemData): Promise<void>
Deletes a data item. The keys must include complete primary keys.

## File Upload API

### upload.uploadFile(file: File): Promise<UploadFileResponse>
Uploads a file to the server. Returns the upload result including filename and link.

### upload.isErrorResponse(response: UploadFileResponse): response is ErrorResponse
Type guard to check if the response is an error response.

## Email API

### email.sendEmail(options: SendEmailOptions): Promise<EmailResponse>
Sends an email through the Resend service. Supports HTML/text content, attachments, scheduling, and more.

## AI API

### DevvAI
Pre-configured OpenAI client (v5.10.2) with automatic authentication. Create an instance after user login to ensure proper authentication.

**Important**: 
- No parameters needed when creating `new DevvAI()` - all authentication and configuration is handled internally for security
- The `model` parameter is required in API calls but will be overridden by Devv backend based on your project configuration

```typescript
// Create AI client after login - no parameters needed
const ai = new DevvAI();

// Example usage
const response = await ai.chat.completions.create({
  model: 'gpt-3.5-turbo', // Required but overridden by backend
  messages: [{ role: 'user', content: 'Hello!' }]
});

// Streaming
const stream = await ai.chat.completions.create({
  model: 'gpt-3.5-turbo',
  messages: [{ role: 'user', content: 'Tell me a story' }],
  stream: true
});
```

For complete usage documentation, refer to the official OpenAI SDK: https://github.com/openai/openai-node

## Type Definitions

```typescript
interface User {
  projectId: string;
  uid: string;
  name: string;
  email: string;
  createdTime: number;
  lastLoginTime: number;
}

interface AuthResponse {
  sid: string;
  user: User;
}

interface GetItemsOptions {
  limit?: number;           // Items per page, max 100, default 20
  cursor?: string;          // Pagination cursor (from previous response's nextCursor)
  sort?: string;            // Sort field (must be range key of current index)
  order?: 'asc' | 'desc';   // Sort order, default 'asc'
  query?: Record<string, string | number | boolean | QueryCondition>;  // Query conditions, fields must be indexed
}

interface QueryCondition {
  operator: QueryOperator;
  value: QueryValue;
}

type QueryOperator = 'EQ' | 'NE' | 'LT' | 'LE' | 'GT' | 'GE' | 'BEGINS_WITH' | 'BETWEEN';
type QueryValue = string | number | boolean | [string | number, string | number];

interface GetItemsResponse {
  items: Record<string, any>[];
  nextCursor?: string;
  indexName?: string;
}

type ItemData = Record<string, any>;

interface UploadFileSuccessResponse {
  [key: string]: string | undefined;
  filename?: string;
  link?: string;
}

interface ErrorResponse {
  errCode: number;
  errMsg: string;
}

type UploadFileResponse = UploadFileSuccessResponse | ErrorResponse;

interface SendEmailOptions {
  from: string;              // Sender email (must be verified)
  to: string[];              // Array of recipient emails
  subject: string;           // Email subject
  bcc?: string[];            // BCC recipients
  cc?: string[];             // CC recipients
  reply_to?: string;         // Reply-to address
  html?: string;             // HTML content
  text?: string;             // Plain text content (at least one of html/text required)
  tags?: EmailTag[];         // Metadata tags
  attachments?: EmailAttachment[];  // File attachments
  headers?: Record<string, string>; // Custom headers
  scheduled_at?: string;     // ISO 8601 timestamp for scheduled delivery
}

interface EmailTag {
  name: string;
  value: string;
}

interface EmailAttachment {
  filename: string;          // Filename with extension
  content?: number[];        // Binary content as byte array (0-255)
  path?: string;             // URL to attachment (either content or path required)
  content_type?: string;     // MIME type
}

interface EmailResponse {
  id: string;                // Email ID for tracking
}
```

## Query Operators

| Operator | Description | Applies To |
|----------|-------------|------------|
| EQ | Equals (default) | Hash key (required), Range key |
| NE | Not equals | Range key only |
| LT | Less than | Range key only |
| LE | Less than or equal | Range key only |
| GT | Greater than | Range key only |
| GE | Greater than or equal | Range key only |
| BEGINS_WITH | Prefix match | Range key only |
| BETWEEN | Range (value must be two-element array) | Range key only |

## Internal Session Management

The SDK automatically handles device identification and session management, completely transparent to users:

### Device ID
- **Storage Location**: `localStorage.getItem('DEVV_CODE_DEVICE_ID')`
- **Generation Time**: Automatically generated during SDK initialization (if not exists)
- **Handling**:
  - Automatically generates UUID v4 format device ID
  - Sent after double SHA256 encryption
  - Automatically included in all API request headers as `Device-Id` field

### Session ID
- **Storage Location**: `localStorage.getItem('DEVV_CODE_SID')`
- **Generation Time**: Automatically saved after successful `verifyOTP` call
- **Clear Time**: Automatically cleared when calling `logout`
- **Handling**:
  - Automatically extracted and saved from response after successful login
  - Automatically included in headers of all authenticated API requests as `sid` field
  - No manual session state management needed

## File Upload Usage Example

```typescript
import { upload } from '@devvai/devv-code-backend';

// Upload a file
async function handleFileUpload(file: File) {
  try {
    const result = await upload.uploadFile(file);
    
    if (upload.isErrorResponse(result)) {
      console.error(`Upload failed: ${result.errMsg}`);
      
      if (result.errCode === 429) {
        console.error('Upload limit exceeded: max 200 uploads per 24 hours');
      }
    } else {
      console.log('Upload successful:', result);
      console.log('File link:', result.link);
    }
  } catch (error) {
    console.error('Upload error:', error);
  }
}

// Example with file input
const fileInput = document.querySelector<HTMLInputElement>('#file-input');
fileInput?.addEventListener('change', (event) => {
  const file = (event.target as HTMLInputElement).files?.[0];
  if (file) {
    handleFileUpload(file);
  }
});
```

## Email Usage Example

```typescript
import { email } from '@devvai/devv-code-backend';

// Send a simple text email
async function sendWelcomeEmail(userEmail: string) {
  try {
    const result = await email.sendEmail({
      from: 'noreply@yourdomain.com',
      to: [userEmail],
      subject: 'Welcome to Our Service',
      text: 'Thank you for signing up!'
    });
    console.log('Email sent:', result.id);
  } catch (error) {
    console.error('Failed to send email:', error);
  }
}

// Send HTML email with attachment
async function sendInvoiceEmail(customerEmail: string, invoiceUrl: string) {
  try {
    const result = await email.sendEmail({
      from: 'billing@yourdomain.com',
      to: [customerEmail],
      subject: 'Your Invoice',
      html: '<h1>Invoice</h1><p>Please find your invoice attached.</p>',
      text: 'Invoice\n\nPlease find your invoice attached.',
      attachments: [{
        filename: 'invoice.pdf',
        path: invoiceUrl,
        content_type: 'application/pdf'
      }],
      tags: [
        { name: 'type', value: 'invoice' },
        { name: 'customer', value: customerEmail }
      ]
    });
    console.log('Invoice email sent:', result.id);
  } catch (error) {
    console.error('Failed to send invoice:', error);
  }
}

// Schedule an email
async function scheduleReminder(userEmail: string, appointmentDate: Date) {
  const reminderDate = new Date(appointmentDate);
  reminderDate.setDate(reminderDate.getDate() - 1); // Day before appointment
  
  try {
    const result = await email.sendEmail({
      from: 'reminders@yourdomain.com',
      to: [userEmail],
      subject: 'Appointment Reminder',
      text: `Reminder: You have an appointment tomorrow at ${appointmentDate.toLocaleTimeString()}.`,
      scheduled_at: reminderDate.toISOString()
    });
    console.log('Reminder scheduled:', result.id);
  } catch (error) {
    console.error('Failed to schedule reminder:', error);
  }
}
```

## Usage Guidelines

1. **Authentication Flow**: First call `sendOTP` to send verification code, then call `verifyOTP` to complete login. It's recommended to use state management libraries (like Zustand) to persist user information.

2. **Query Constraints**:
   - Returns all data using default `_tid_id_idx` index when no parameters provided
   - Conditional queries must be based on indexed fields (primary or secondary index)
   - Primary index is fixed as `_uid` (user ID) and `_id` (time-ordered ID)
   - Hash keys can only use EQ operator, other operators will cause errors
   - Range keys can use all operators
   - Special case: When `_tid` is the hash key of an index, the system fills it automatically, no manual specification needed

3. **Sorting Rules**:
   - `sort` field must be the range key of the currently used index
   - Cannot sort by arbitrary fields

4. **Route Protection**: You need to implement authentication guards yourself to check user login status and handle route redirects.

5. **Error Handling**: All methods may throw exceptions, please use try-catch for handling.

6. **Pagination Best Practices**: Use cursor pagination, not offset. Cursors remain valid as long as the data structure doesn't change.

7. **File Upload Limits**: Maximum 200 file uploads per 24 hours per user. Files are automatically handled with proper multipart/form-data encoding.

8. **Email Requirements**:
   - `from` address must be from a verified domain or email address
   - At least one of `html` or `text` content is required
   - For attachments, provide either `content` (byte array) or `path` (URL), not both
   - Scheduled emails must have a future `scheduled_at` timestamp

9. **AI Chat Usage**:
   - Requires active session (must login first with `auth.verifyOTP()`)
   - The `model` parameter is required but ignored - Devv backend controls the actual model
   - Full OpenAI SDK compatibility - all features work identically
   - No additional dependencies needed - OpenAI SDK is included

## Important Notes

- Device ID and Session ID are stored in localStorage, clearing browser data will lose them
- Queries don't support non-indexed fields, attempting to query non-indexed fields will cause errors
- BETWEEN operator value must be a two-element array
- The system automatically selects the appropriate index based on your query parameters
- Performance consideration: Use indexed fields for queries to achieve optimal performance